# 1st pipeline

name: Smallscreen-pipeline

on:
 push:
    branches: [ "feature-DEV" ]


jobs:
    build:
      runs-on: self-hosted

      steps:
       
        - name: GIT-CHECKOUT
          uses: actions/checkout@v4

        - name: JAVA INSTALLING
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'

            # here mvn package --file pom.xml we can include
        - name: BUILD WITH MAVEN
          run: |
            mvn package 
            
        - name: Uploading ARTIFACTS TO REPO
          uses: actions/upload-artifact@v4
          with:
            name: FirstTRYY-artifact
            path: target/*.jar


        - name: TRIVY SCAN FOR VUL
          run: |
            trivy fs . --format table -o trivy-fs-report.html

        - name: Install REQUIRED TOOL FOR SONAR
          run: |
            sudo apt-get update
            sudo apt-get install -y unzip curl

        - name: SONAR-SCAN
          uses: sonarsource/sonarqube-scan-action@v7
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

        # - name: Install jq
        #   run: sudo apt-get update && sudo apt-get install -y jq


        - name: SONAR_GATE_CHECK
          id: sonarqube-quality-gate-check
          uses: sonarsource/sonarqube-quality-gate-action@v1
          timeout-minutes: 5
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}



        - name: SET UP QEMU
          uses: docker/setup-qemu-action@v3


        - name: SET UP DOCKER BUILDX
          uses: docker/setup-buildx-action@v3


        - name: BUILD - DOCKER - IMAGE
          run: |
            docker build -t kasunurmahi/firsttry:latey .


        - name: TRIVY-SCAN FOR IMAGE
          run: |
            trivy image --format table -o trivy-image-report.html kasunurmahi/firsttry:latey


        - name: LOGIN TO DOCKER HUB
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

            
        - name: PUSHING IMAGE TO DOCKERHUB
          run: |
            docker push kasunurmahi/firsttry:latey



        - name: KUBERNETES-DEPLOY
          uses: tale/kubectl-action@v1
          with:
            base64-kube-config: ${{ secrets.KUBE_CONFIG }} 

        - name:  run manisfest   
          run: |
             
             kubectl apply -f deployment-service.yaml -n mahidhar
             kubectl get svc -n mahihdar
             kubectl get pods -n mahidhar
            

            
            




   
            
          
          
          

        
     
        

         
            

        

        
        
